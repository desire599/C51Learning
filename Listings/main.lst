C51 COMPILER V9.60.0.0   MAIN                                                              11/26/2020 23:45:08 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE src\main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTE
                    -ND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg52.h>
   2          #include <intrins.h>
   3          sbit SCL = P1 ^ 7;   //I2Cʱ
   4          sbit SDA = P1 ^ 6;   //I2C
   5          bit bdata IIC_ERROR; //I2CӦ־λIIC_ERRORΪԶbdataı20H~2FHRAM16
             -byteΧɶддbdataҲԣϵͳڴռ
   6          //ʱ4΢뺯
   7          void Delay4us()
   8          {
   9   1          _nop_();
  10   1          _nop_();
  11   1          _nop_();
  12   1          _nop_();
  13   1      }
  14          
  15          //1iic_start
  16          //ܣI2CߣI2CʼβΣޣֵ
  17          void IIC_Start()
  18          {
  19   1          SDA = 1;    //߸ߵƽ
  20   1          SCL = 1;    //ʱ߸ߵƽ
  21   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  22   1          SDA = 0;    //ʱ߸ߵƽʱSDAߴӸߵƽתΪ͵ƽһ䣬I2Cͨſʼ
  23   1          Delay4us();
  24   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  25   1      }
  26          
  27          //5iic_stop
  28          //ܣֹͣI2CݴͣβΣޣֵ
  29          void IIC_Stop()
  30          {
  31   1          SDA = 0;    //ߵ͵ƽ
  32   1          SCL = 1;    //ʱ߸ߵƽ
  33   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  34   1          SDA = 1;    //ʱ߸ߵƽʱSDAߴӵ͵ƽתΪߵƽһ䣬I2CͨŽ
  35   1          Delay4us();
  36   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  37   1      }
  38          
  39          //2IICSendByte
  40          //ܣƬһֽڣһֽ8λɣI2C豸βΣҪ͵ݡֵ
             -ޡ
  41          void IIC_SendByte(unsigned char sendData)
  42          {
  43   1          unsigned char i = 8;    //ҪSDAϷһֽݣ8λԶѭi
  44   1          for (i = 0; i < 8; i++) //ѭ8λ
  45   1          {
  46   2              SDA = (bit)(sendData & 0x80); //ʱǰIIC_startʱSCLΪ͵ƽſԷݵSDA
  47   2              //ΪSDAȴ͵λҪʣµĵ7λ0x80&㡱
  48   2              //bitΪǿƽ֮ĽתΪλΪ10SDA
  49   2              SCL = 1;        //ٰSCLΪ1SDAϵȶݵķ
  50   2              Delay4us();     //ȴ4ںȷѾ
  51   2              SCL = 0;        //λSCLΪ0һβܰݴSDA
  52   2              sendData <<= 1; //Ҫ͵1λ0x80㣬ʵݣ8λƣ8
C51 COMPILER V9.60.0.0   MAIN                                                              11/26/2020 23:45:08 PAGE 2   

             -ɷ
  53   2          }
  54   1          Delay4us();
  55   1      }
  56          
  57          //4check_ACK
  58          //ܣƬڷһݺҪȡI2C豸ӦźšβΣޡֵޡ
  59          void check_ACK()
  60          {
  61   1          SDA = 1;         //ʱI2C豸ǿΪȡ״̬ƬȡI2CӦźţSDAд1SDAд0
             -дݵPCF8591оƬ
  62   1          SCL = 1;         //ʱΪ1ȶSDAݣݶȡ
  63   1          Delay4us();      //ȴȡݵ
  64   1          IIC_ERROR = SDA; //ѴʱȡSDAźŴIIC_ERRORIIC_ERRORֵΪ1ʾӦ
             -0Ӧͨ
  65   1          SCL = 0;         //λʱΪ͵ƽ޸SDA
  66   1          Delay4us();
  67   1      }
  68          
  69          //5IICReceiveByte
  70          //ܣƬմI2CصһֽݡβΣޡֵؽյ
  71          unsigned char IIC_ReceiveByte()
  72          {
  73   1          unsigned char i = 8;       //I2C豸ҪһֽݸƬ8λԶѭ
             -i
  74   1          unsigned char receiveData; //ݵıreceiveData
  75   1          while (i--)
  76   1          {
  77   2              SDA = 1;      //ʱI2C豸ǿΪȡ״̬ƬI2CķݣSDAд1SDAд0
             -дݵPCF8591оƬ
  78   2              SCL = 1;      //ʱΪ1ȶSDAݣݶȡ
  79   2              Delay4us();   //ȴȡݵ
  80   2              if (SDA == 1) //ΪSDAÿֻܶдһλҪ8һ뵽receiveData
  81   2              {
  82   3                  receiveData = receiveData | 0x01; //յλΪ1ֻreceiveDataһλΪ1
  83   3                  //ΪI2C豸صÿδλģÿȷŵλ8
             -ξͻصλ
  84   3              }
  85   2              else
  86   2              {
  87   3                  receiveData = receiveData & 0xfe; //յλΪ0ֻreceiveDataһλΪ0
  88   3              }
  89   2              SCL = 0;                        //λʱΪ͵ƽ޸SDA
  90   2              receiveData = receiveData << 1; //ŰѴ洢ݵı1λԱ洢һݵλӶ
             -ʵλSDA߶ȡ
  91   2          }
  92   1          return receiveData;
  93   1      }
  94          
  95          //һ8λDAתģ
  96          void DAC_PCF8591(unsigned char controlByte, unsigned char writeData)
  97          {
  98   1          IIC_Start();               //1ͨ
  99   1          IIC_SendByte(0x90);        //2дַ
 100   1          check_ACK();               //3ÿηһֽھҪӦλ
 101   1          if (IIC_ERROR == 1)        //ӦźŵķֵжǷӦʧܣΪ1
 102   1              return ;              //򷵻0ϵͳ
 103   1          IIC_SendByte(controlByte); //Ϳֽ
 104   1          check_ACK();               //ÿηһֽھҪӦλ
 105   1          if (IIC_ERROR == 1)
 106   1              return ;
 107   1          IIC_SendByte(writeData);
C51 COMPILER V9.60.0.0   MAIN                                                              11/26/2020 23:45:08 PAGE 3   

 108   1          check_ACK(); //ÿηһֽھҪӦλ
 109   1          if (IIC_ERROR == 1)
 110   1              return ;
 111   1          IIC_Stop();
 112   1      }
 113          
 114          //  PCF8591ֽڽDAתݲ
 115          //
 116          void main()
 117          {
 118   1          unsigned char i;
 119   1          unsigned int j;
 120   1          while (1)
 121   1          {
 122   2              for (i = 0; i < 255; i++)
 123   2              {
 124   3                  DAC_PCF8591(0x40, i);//ѿֵֺDAתĺ
 125   3                  for(j=0;j<3000;j++);//ÿʱԼ30ms
 126   3              }
 127   2              for (i = 255; i > 0; i--)
 128   2              {
 129   3                  DAC_PCF8591(0x40, i);
 130   3                  for(j=0;j<3000;j++);//ÿʱԼ30ms
 131   3              }
 132   2          }
 133   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    222    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
