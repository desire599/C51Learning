C51 COMPILER V9.60.0.0   MAIN                                                              11/28/2020 00:43:28 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE src\main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTE
                    -ND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          //8-2ADתʾѹֵ׵ѹ
   2          #include <reg52.h>
   3          #include <intrins.h> //nop
   4          sbit SCL = P1 ^ 7;   //I2Cʱ
   5          sbit SDA = P1 ^ 6;   //I2C
   6          sbit DP = P3 ^ 7;    //ܵDPţС
   7          bit bdata IIC_ERROR; //I2CӦ־λIIC_ERRORΪԶbdataı20H~2FHRAM16
             -byteΧɶддbdataҲԣϵͳڴռ
   8          //ȫ飬ڴ洢4ʾܶӦʾֵ
   9          unsigned char disp[4] = {0, 0, 0, 0};
  10          
  11          //ʱ4΢뺯ÿnopִһڣ12MHzľ1sĻ
  12          void Delay4us()
  13          {
  14   1          _nop_();
  15   1          _nop_();
  16   1          _nop_();
  17   1          _nop_();
  18   1      }
  19          
  20          //1iic_start
  21          //ܣI2CߣI2CʼβΣޣֵ
  22          void IIC_Start()
  23          {
  24   1          SDA = 1;    //߸ߵƽ
  25   1          SCL = 1;    //ʱ߸ߵƽ
  26   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  27   1          SDA = 0;    //ʱ߸ߵƽʱSDAߴӸߵƽתΪ͵ƽһ䣬I2Cͨſʼ
  28   1          Delay4us();
  29   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  30   1      }
  31          
  32          //5iic_stop
  33          //ܣֹͣI2CݴͣβΣޣֵ
  34          void IIC_Stop()
  35          {
  36   1          SDA = 0;    //ߵ͵ƽ
  37   1          SCL = 1;    //ʱ߸ߵƽ
  38   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  39   1          SDA = 1;    //ʱ߸ߵƽʱSDAߴӵ͵ƽתΪߵƽһ䣬I2CͨŽ
  40   1          Delay4us();
  41   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  42   1      }
  43          
  44          //2IICSendByte
  45          //ܣƬһֽڣһֽ8λɣI2C豸βΣҪ͵ݡֵ
             -ޡ
  46          void IIC_SendByte(unsigned char sendData)
  47          {
  48   1          unsigned char i = 8;    //ҪSDAϷһֽݣ8λԶѭi
  49   1          for (i = 0; i < 8; i++) //ѭ8λ
  50   1          {
  51   2              SDA = (bit)(sendData & 0x80); //ʱǰIIC_startʱSCLΪ͵ƽſԷݵSDA
  52   2              //ΪSDAȴ͵λҪʣµĵ7λ0x80&㡱
C51 COMPILER V9.60.0.0   MAIN                                                              11/28/2020 00:43:28 PAGE 2   

  53   2              //bitΪǿƽ֮ĽתΪλΪ10SDA
  54   2              SCL = 1;        //ٰSCLΪ1SDAϵȶݵķ
  55   2              Delay4us();     //ȴ4ںȷѾ
  56   2              SCL = 0;        //λSCLΪ0һβܰݴSDA
  57   2              sendData <<= 1; //Ҫ͵1λ0x80㣬ʵݣ8λƣ8
             -ɷ
  58   2          }
  59   1          Delay4us();
  60   1      }
  61          
  62          //4check_ACK
  63          //ܣƬڷһݺҪȡI2C豸ӦźšβΣޡֵޡ
  64          void check_ACK()
  65          {
  66   1          SDA = 1;         //ʱI2C豸ǿΪȡ״̬ƬȡI2CӦźţSDAд1SDAд0
             -дݵPCF8591оƬ
  67   1          SCL = 1;         //ʱΪ1ȶSDAݣݶȡ
  68   1          Delay4us();      //ȴȡݵ
  69   1          IIC_ERROR = SDA; //ѴʱȡSDAźŴIIC_ERRORIIC_ERRORֵΪ1ʾӦ
             -0Ӧͨ
  70   1          SCL = 0;         //λʱΪ͵ƽ޸SDA
  71   1          Delay4us();
  72   1      }
  73          
  74          //5IICReceiveByte
  75          //ܣƬմI2CصһֽݡβΣޡֵؽյ
  76          unsigned char IIC_ReceiveByte()
  77          {
  78   1          unsigned char i = 8;       //I2C豸ҪһֽݸƬ8λԶѭ
             -i
  79   1          unsigned char receiveData; //ݵıreceiveData
  80   1          while (i--)
  81   1          {
  82   2              SDA = 1;                        //ʱI2C豸ǿΪȡ״̬ƬI2CķݣSD
             -Aд1SDAд0дݵPCF8591оƬ
  83   2              SCL = 1;                        //ʱΪ1ȶSDAݣݶȡ
  84   2              Delay4us();                     //ȴȡݵ
  85   2              receiveData = receiveData << 1; //ݴҪȰѴ洢ݵı1λ
             -Ա洢һݵλӶʵλSDA߶ȡ
  86   2              if (SDA == 1)                   //ΪSDAÿֻܶдһλҪ8һ뵽receiveDat
             -a
  87   2              {
  88   3                  receiveData = receiveData | 0x01; //յλΪ1ֻreceiveDataһλΪ1
  89   3                  //ΪI2C豸صÿδλģÿȷŵλ8
             -ξͻصλ
  90   3              }
  91   2              else
  92   2              {
  93   3                  receiveData = receiveData & 0xfe; //յλΪ0ֻreceiveDataһλΪ0
  94   3              }
  95   2              SCL = 0; //λʱΪ͵ƽ޸SDA
  96   2          }
  97   1          return receiveData;
  98   1      }
  99          
 100          //send_ACK
 101          //ܣƬյPCFоƬķֵʱӦλPCFоƬ
 102          void send_ACK()
 103          {
 104   1          SDA = 0; //һĲSCL=0ʱΪӵƬPCFоƬһSDAĵ͵ƽʾƬѾյ
             -
 105   1          SCL = 1; //ʱ1ȶݣ÷͹ȥ
C51 COMPILER V9.60.0.0   MAIN                                                              11/28/2020 00:43:28 PAGE 3   

 106   1          Delay4us();
 107   1          SDA = 1; //
 108   1          SCL = 0; //λʱΪ͵ƽ޸SDA
 109   1          Delay4us();
 110   1      }
 111          
 112          //send_NoACK
 113          //ܣƬٷ޷ӦλPCFоƬԶ
 114          void send_NoACK()
 115          {
 116   1          SDA = 1; //ӵƬһߵƽPCFоƬʾӦҲ޷ӦԶ
 117   1          SCL = 1; //ʱ1ȶݣ÷͹ȥ
 118   1          Delay4us();
 119   1          SDA = 0; //λ
 120   1          SCL = 0; //λʱΪ͵ƽ޸SDA
 121   1          Delay4us();
 122   1      }
 123          
 124          //ȷźŸPCFоƬٶȡAIN0ͨ0ĵѹģźţADת󣬰ظƬ
 125          unsigned char ADC_PCF8591(unsigned char controlByte)
 126          {
 127   1          unsigned char idata receiveFromPCF;
 128   1          IIC_Start();               //1ͨ
 129   1          IIC_SendByte(0x90);        //2дַ
 130   1          check_ACK();               //3ÿηһֽھҪӦλ
 131   1          if (IIC_ERROR == 1)        //ӦźŵķֵжǷӦʧܣΪ1
 132   1              return 0;              //򷵻0ϵͳ
 133   1          IIC_SendByte(controlByte); //4Ϳֽ0x00ʾģͨ0ADת
 134   1          check_ACK();               //ÿηһֽھҪӦλ
 135   1          if (IIC_ERROR == 1)
 136   1              return 0;
 137   1          IIC_Stop();         //ֹͨ
 138   1          IIC_Start();        //5ͨ
 139   1          IIC_SendByte(0x91); //6Ͷַ
 140   1          check_ACK();        //ÿηһֽھҪӦλȷ
 141   1          if (IIC_ERROR == 1)
 142   1              return 0;
 143   1          receiveFromPCF = IIC_ReceiveByte(); //7õƬPCFоƬĳ򣬰Ѷȡֵ
 144   1          send_ACK();                         //8ƬӦźŸPCFоƬ
 145   1          send_NoACK();                       //9Ƭ޷ӦźŸPCFоƬǿPCFоƬΪ޷Ӧ
             -ֹͨţ˾ҪУ򷵻ص׼ȷ
 146   1          IIC_Stop();                         //10ֹͨ
 147   1          return receiveFromPCF;              //11PCFоƬⲿģͨ0ת
 148   1      }
 149          
 150          //ѹֵݴ:dataProcess
 151          //ֱõѹֵλdisp[]УԱܵʾ
 152          void dataProcess(unsigned char digital)
 153          {
 154   1          //ͨ0DAת󷵻ص
 155   1          unsigned int voltage; //ͨ0ĵѹֵתѹֵ
 156   1          voltage = 196 * digital;
 157   1          //ѹȹϵԵõתʽ5V/255=voltage/digital
 158   1          //voltage=5*digital/255=0.0196*digital
 159   1          //Ϊʾ4ϣԷŴ10000ʾvoltage=196*digital
 160   1          disp[3] = voltage / 10000;       //ΪŴһ򱶣ȵõλֵ
 161   1          disp[2] = (voltage / 1000) % 10; //õǧλֵ
 162   1          disp[1] = (voltage / 100) % 10;  //õλֵ
 163   1          disp[0] = (voltage / 10) % 10;   //õʮλֵλҪ
 164   1      }
 165          
 166          //ܣ4LEDʾѹ4λ
C51 COMPILER V9.60.0.0   MAIN                                                              11/28/2020 00:43:28 PAGE 4   

 167          //ڲ
 168          //ڲ
 169          void display()
 170          {
 171   1          unsigned char i, j, temp;
 172   1          unsigned char code led[] = {0x3f, 0x06, 0x5b, 0x4f, 0x66, 0x6d, 0x7d, 0x07, 0x7f, 0x6f};
 173   1          //09ʾ룬ܣùΪ͵ƽܼʹ
 174   1          temp = 0x01; //һtempλ״̬0000 0001
 175   1          //Ϊλ<<λԶ0ǵ͵ƽЧԲֱ1111 1110
 176   1          //ֱдP2=0x01ںִforѭһP2=0xffʱǵӶ޷ʵλѭ
 177   1          for (i = 0; i < 4; i++)
 178   1          {
 179   2              P2 = 0xff & 0x0f;  // θλҪεӦλ00000 1111=0x3f6λΪߵ
             -ƽÿαҪϨȫܣ̬޷ʾ
 180   2              P3 = led[disp[i]]; //ѡledӦݵP3ڣʾ
 181   2              P2 = ~temp;        //tempȡ0000 0001Ϊ1111 1110ֵP2ʱֻ򿪵һP2.0
 182   2              if(i==3)
 183   2                  DP = 1;//4ʾʱСDP
 184   2              for (j = 0; j < 100; j++)
 185   2                  ;       //ѭʱԼ1ms
 186   2              temp <<= 1; //wıһλ0000 0010ڶѭʱP2=~temp=1111 1101ֻ򿪵ڶ
             -P2.1
 187   2                          //forѭwhile(1)disp()½disp()Ӻִtemp=0x
             -01ֿѭtempȫ0.
 188   2          }
 189   1      }
 190          
 191          //ʱ
 192          void delay(unsigned int i)
 193          {
 194   1          while (i--)
 195   1              ;
 196   1      }
 197          //
 198          void main()
 199          {
 200   1          unsigned char digitalData; //PCFоƬĴű
 201   1          while (1)
 202   1          {
 203   2              digitalData = ADC_PCF8591(0x00); //ADתд0x00ʾͨ0ȡⲿѹתΪ
             -digitalData
 204   2              dataProcess(digitalData);        //дݴõʾλ
 205   2              display();                       //ʾ
 206   2              delay(1000);
 207   2          }
 208   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    378    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----       1
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
