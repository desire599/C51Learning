C51 COMPILER V9.60.0.0   MAIN                                                              11/27/2020 19:38:40 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE src\main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTE
                    -ND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          //8-3ƬͨDAתLED-յĳ
   2          #include <reg52.h>
   3          #include <intrins.h>     //nop
   4          sbit SCL = P1 ^ 7;       //I2Cʱ
   5          sbit SDA = P1 ^ 6;       //I2C
   6          sbit lightUp = P3 ^ 0;   //ƹӰP3.0
   7          sbit lightDown = P3 ^ 1; //ƹP3.1
   8          bit bdata IIC_ERROR;     //I2CӦ־λIIC_ERRORΪԶbdataı20H~2FHRAM
             -16byteΧɶддbdataҲԣϵͳڴռ
   9          //ʱ4΢뺯ÿnopִһڣ12MHzľ1sĻ
  10          void Delay4us()
  11          {
  12   1          _nop_();
  13   1          _nop_();
  14   1          _nop_();
  15   1          _nop_();
  16   1      }
  17          
  18          //1iic_start
  19          //ܣI2CߣI2CʼβΣޣֵ
  20          void IIC_Start()
  21          {
  22   1          SDA = 1;    //߸ߵƽ
  23   1          SCL = 1;    //ʱ߸ߵƽ
  24   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  25   1          SDA = 0;    //ʱ߸ߵƽʱSDAߴӸߵƽתΪ͵ƽһ䣬I2Cͨſʼ
  26   1          Delay4us();
  27   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  28   1      }
  29          
  30          //5iic_stop
  31          //ܣֹͣI2CݴͣβΣޣֵ
  32          void IIC_Stop()
  33          {
  34   1          SDA = 0;    //ߵ͵ƽ
  35   1          SCL = 1;    //ʱ߸ߵƽ
  36   1          Delay4us(); //ʼʱҪ4.7sԵʱ
  37   1          SDA = 1;    //ʱ߸ߵƽʱSDAߴӵ͵ƽתΪߵƽһ䣬I2CͨŽ
  38   1          Delay4us();
  39   1          SCL = 0; //λʱΪ͵ƽ޸SDAݣжд
  40   1      }
  41          
  42          //2IICSendByte
  43          //ܣƬһֽڣһֽ8λɣI2C豸βΣҪ͵ݡֵ
             -ޡ
  44          void IIC_SendByte(unsigned char sendData)
  45          {
  46   1          unsigned char i = 8;    //ҪSDAϷһֽݣ8λԶѭi
  47   1          for (i = 0; i < 8; i++) //ѭ8λ
  48   1          {
  49   2              SDA = (bit)(sendData & 0x80); //ʱǰIIC_startʱSCLΪ͵ƽſԷݵSDA
  50   2              //ΪSDAȴ͵λҪʣµĵ7λ0x80&㡱
  51   2              //bitΪǿƽ֮ĽתΪλΪ10SDA
  52   2              SCL = 1;        //ٰSCLΪ1SDAϵȶݵķ
C51 COMPILER V9.60.0.0   MAIN                                                              11/27/2020 19:38:40 PAGE 2   

  53   2              Delay4us();     //ȴ4ںȷѾ
  54   2              SCL = 0;        //λSCLΪ0һβܰݴSDA
  55   2              sendData <<= 1; //Ҫ͵1λ0x80㣬ʵݣ8λƣ8
             -ɷ
  56   2          }
  57   1          Delay4us();
  58   1      }
  59          
  60          //4check_ACK
  61          //ܣƬڷһݺҪȡI2C豸ӦźšβΣޡֵޡ
  62          void check_ACK()
  63          {
  64   1          SDA = 1;         //ʱI2C豸ǿΪȡ״̬ƬȡI2CӦźţSDAд1SDAд0
             -дݵPCF8591оƬ
  65   1          SCL = 1;         //ʱΪ1ȶSDAݣݶȡ
  66   1          Delay4us();      //ȴȡݵ
  67   1          IIC_ERROR = SDA; //ѴʱȡSDAźŴIIC_ERRORIIC_ERRORֵΪ1ʾӦ
             -0Ӧͨ
  68   1          SCL = 0;         //λʱΪ͵ƽ޸SDA
  69   1          Delay4us();
  70   1      }
  71          
  72          //5IICReceiveByte
  73          //ܣƬմI2CصһֽݡβΣޡֵؽյ
  74          unsigned char IIC_ReceiveByte()
  75          {
  76   1          unsigned char i = 8;       //I2C豸ҪһֽݸƬ8λԶѭ
             -i
  77   1          unsigned char receiveData; //ݵıreceiveData
  78   1          while (i--)
  79   1          {
  80   2              SDA = 1;      //ʱI2C豸ǿΪȡ״̬ƬI2CķݣSDAд1SDAд0
             -дݵPCF8591оƬ
  81   2              SCL = 1;      //ʱΪ1ȶSDAݣݶȡ
  82   2              Delay4us();   //ȴȡݵ
  83   2              if (SDA == 1) //ΪSDAÿֻܶдһλҪ8һ뵽receiveData
  84   2              {
  85   3                  receiveData = receiveData | 0x01; //յλΪ1ֻreceiveDataһλΪ1
  86   3                  //ΪI2C豸صÿδλģÿȷŵλ8
             -ξͻصλ
  87   3              }
  88   2              else
  89   2              {
  90   3                  receiveData = receiveData & 0xfe; //յλΪ0ֻreceiveDataһλΪ0
  91   3              }
  92   2              SCL = 0;                        //λʱΪ͵ƽ޸SDA
  93   2              receiveData = receiveData << 1; //ŰѴ洢ݵı1λԱ洢һݵλӶ
             -ʵλSDA߶ȡ
  94   2          }
  95   1          return receiveData;
  96   1      }
  97          
  98          //һ8λDAתģ
  99          void DAC_PCF8591(unsigned char controlByte, unsigned char writeData)
 100          {
 101   1          IIC_Start();               //1ͨ
 102   1          IIC_SendByte(0x90);        //2дַ
 103   1          check_ACK();               //3ÿηһֽھҪӦλ
 104   1          if (IIC_ERROR == 1)        //ӦźŵķֵжǷӦʧܣΪ1
 105   1              return;                //򷵻0ϵͳ
 106   1          IIC_SendByte(controlByte); //4Ϳֽ
 107   1          check_ACK();               //ÿηһֽھҪӦλ
C51 COMPILER V9.60.0.0   MAIN                                                              11/27/2020 19:38:40 PAGE 3   

 108   1          if (IIC_ERROR == 1)
 109   1              return;
 110   1          IIC_SendByte(writeData); //5
 111   1          check_ACK();             //ÿηһֽھҪӦλ
 112   1          if (IIC_ERROR == 1)
 113   1              return;
 114   1          IIC_Stop(); //6ͨ
 115   1      }
 116          
 117          //ʱ
 118          //ܣʵִʱ
 119          void delay(unsigned int i)
 120          {
 121   1          while (i--)
 122   1              ;
 123   1      }
 124          //  PCF8591ֽڽDAתݲ
 125          //
 126          void main()
 127          {
 128   1          unsigned char i = 125; //ʼΪ255мֵ125ʱѹΪ2.5V
 129   1          while (1)
 130   1          {
 131   2              if (lightUp == 0)
 132   2              {
 133   3                  delay(1000);
 134   3                  if (lightUp == 0)
 135   3                  {
 136   4                      //while(!lightUp);
 137   4                      //delay(1000);
 138   4                      i = i + 5;
 139   4                      if (i == 255)
 140   4                          i = 125;
 141   4                  }
 142   3              }
 143   2              if (lightDown == 0)
 144   2              {
 145   3                  delay(1000);
 146   3                  if (lightDown == 0)
 147   3                  {
 148   4                      //while(!lightDown);
 149   4                      //delay(1000);
 150   4                      i = i - 5;
 151   4                      if (i == 0)
 152   4                          i = 125;
 153   4                  }
 154   3              }
 155   2              DAC_PCF8591(0x40, i); //ѿֵֺDAתĺ
 156   2              delay(1000);
 157   2          }
 158   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    214    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.60.0.0   MAIN                                                              11/27/2020 19:38:40 PAGE 4   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
